unit uCommom;

interface

uses uDm, Vcl.Dialogs;

type
  TGlobal = class
  Email : String;
  Apelido : String;
  EmailDestinatario : String;
  ApelidoDestinatario : String;

  procedure AtivarDataModule;
  procedure DesativarDataModule;
  procedure SetEmailOnline;
  procedure SetEmailOffline;
end;

implementation

{ TGlobal }

procedure TGlobal.AtivarDataModule;
begin
  with Dm do
  begin
    FDConnection.Connected := True;

    QueryUsuario.Active := True;
    QueryUsuOnline.Active := True;
    Query.Active := True;
    QueryIndividual.Active := True;

    TableUsuario.Active := True;
    TableMensagem.Active := True;
  end;
end;

procedure TGlobal.DesativarDataModule;
begin
    with Dm do
    begin
      QueryUsuario.Active := False;
      QueryUsuOnline.Active := False;
      Query.Active := False;
      QueryIndividual.Active := False;

      TableUsuario.Active := False;
      TableMensagem.Active := False;
    end;
end;

procedure TGlobal.SetEmailOffline;
begin
  with Dm.QuerySetOffline do
  begin
    Params[0].Value := Email;
    ExecSQL;
  end;
end;

procedure TGlobal.SetEmailOnline;
begin
  with Dm.QuerySetOnline do
  begin
    Params[0].Value := Email;
    Post;
  end;

  with Dm.TableUsuario do
  begin
    Close;
    SQL.Clear;
    SQL.Add('Select nomeusu as apelido, emailusu as email, online from chatusuario');
    SQL.Add(' where emailusu = :mail');
    ParamByName('mail').AsString := Email;
    Open;

    if (not IsEmpty) and (Fields[2].Text = '0') then
      ShowMessage('Não atualizou');

    Close;
  end;
end;

end.
