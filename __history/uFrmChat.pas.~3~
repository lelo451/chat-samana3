unit uFrmChat;
interface
uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Data.DB,
  Vcl.Grids, Vcl.DBGrids, FireDAC.Stan.Param, Vcl.Buttons,System.Notification,
  System.ImageList, Vcl.ImgList, uDm, uUsuario;
type
  TFrmChat = class(TForm)
    PanelTop: TPanel;
    LbApelido: TLabel;
    LbStatus: TLabel;
    DSUsuario: TDataSource;
    PanelChat: TPanel;
    MChatConteudo: TMemo;
    EdTexto: TEdit;
    Timer01: TTimer;
    Panel2: TPanel;
    BtnEnviar: TSpeedButton;
    ImageList: TImageList;
    Panel1: TPanel;
    DBGrid: TDBGrid;
    BtnConversar: TButton;
    procedure FormShow(Sender: TObject);
    procedure Timer01Timer(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure BtnChatClearClick(Sender: TObject);
    procedure EdTextoKeyPress(Sender: TObject; var Key: Char);
    procedure BtnEnviarClick(Sender: TObject);
    procedure NotificationCenter1PermissionRequestResult(Sender: TObject;
      const AIsGranted: Boolean);
    procedure BtnConversarClick(Sender: TObject);
    procedure DBGridDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure FormDestroy(Sender: TObject);
  private

    { Private declarations }
  public
    { Public declarations }
    procedure UpdateMemo();
  end;
var
  FrmChat: TFrmChat;
implementation
{$R *.dfm}

uses
  uFrmSingleChat;

procedure TFrmChat.BtnEnviarClick(Sender: TObject);//Salva mensagens no banco
var
  Mensagem, From: String;
begin
  if EdTexto.Text <> '' then
    begin
      MChatConteudo.Clear;
      uUsuario.Usuario.Mensagens(EdTexto.Text);
      uUsuario.Usuario.UpdateChat;
      EdTexto.Clear;
      EdTexto.SetFocus;
    end
    else
    begin
      ShowMessage('Campo de mensagem vázio.');
    end;
end;

procedure TFrmChat.DBGridDrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumn; State: TGridDrawState);//tentativa de colocar imagem para online/offline
begin
  inherited;
  if Column.FieldName = 'ONLINE' then
  begin
    DBGrid.Canvas.FillRect(Rect);
    ImageList.Draw(TDBGrid(Sender).Canvas, Rect.Left + 10, Rect.Top + 1, -1);
    if Column.Field.AsInteger = 1 then
      ImageList.Draw(TDBGrid(Sender).Canvas, Rect.Left + 10, Rect.Top + 1, 0)
    else
      ImageList.Draw(TDBGrid(Sender).Canvas, Rect.Left + 10, Rect.Top + 1, 1);
  end;
end;

procedure TFrmChat.BtnConversarClick(Sender: TObject);//Busca historio no click
begin
  uUsuario.Usuario.Destinatario := DBGrid.Columns.Items[2].Field.Text;
  uUsuario.Usuario.NomeDes      := DBGrid.Columns.Items[0].Field.Text;
  FrmSingleChat := TFrmSingleChat.Create(NIL);
  uFrmSingleChat.FrmSingleChat.ShowModal;
end;

procedure TFrmChat.EdTextoKeyPress(Sender: TObject; var Key: Char);//para aperta enter
begin
  if Key = #13 then
    begin
      BtnEnviar.Click;
    end;
end;

procedure TFrmChat.BtnChatClearClick(Sender: TObject);//linmpa caixa de texto
begin
  EdTexto.Clear;
end;

procedure TFrmChat.FormClose(Sender: TObject; var Action: TCloseAction);//quando fecha o chat
begin
  uUsuario.Usuario.UpdateOffline;
  Timer01.Enabled := False;
end;

procedure TFrmChat.FormDestroy(Sender: TObject);
begin
  uUsuario.Usuario.UpdateOffline;
  Timer01.Enabled := False;
end;

procedure TFrmChat.FormShow(Sender: TObject);//OnShow
begin
  DSUsuario.DataSet.Active := true;
  MChatConteudo.Lines.Add(uUsuario.Usuario.MensagensHistorico);
  uUsuario.Usuario.MensagensHistorico;
  Timer01.Enabled := True;
  LbApelido.Caption := uUsuario.Usuario.Apelido;
  LbStatus.Caption := 'ONLINE';
  end;

procedure TFrmChat.NotificationCenter1PermissionRequestResult(Sender: TObject;
  const AIsGranted: Boolean); //notifica da mensagem enviada
begin
     showmessage('Enviei');
end;

procedure TFrmChat.Timer01Timer(Sender: TObject);//timer
begin
  uUsuario.Usuario.UpdateChat;
  DSUsuario.DataSet.Refresh;
end;

procedure TFrmChat.UpdateMemo();//atualiza o memo
begin
  FrmChat.MChatConteudo.Clear;
  uUsuario.Usuario.MensagensHistorico;
end;

end.
